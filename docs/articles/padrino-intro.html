<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RPadrino Introduction • RPadrino</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/yeti/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="RPadrino Introduction">
<meta property="og:description" content="RPadrino">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">RPadrino</a>
        <span class="version label label-danger" data-toggle="tooltip" data-placement="bottom" title="Unreleased version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Functions</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Vignettes
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/padrino-intro.html">Introduction to RPadrino</a>
    </li>
    <li>
      <a href="../articles/data-cleaning.html">Data Cleaning and Troubleshooting</a>
    </li>
    <li>
      <a href="../articles/interop.html">PADRINO and Other Databases</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="padrino-intro_files/header-attrs-2.11/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>RPadrino Introduction</h1>
            
            <h4 class="date">2021-10-26</h4>
      
      
      <div class="hidden name"><code>padrino-intro.Rmd</code></div>

    </div>

    
    
<div id="package-overview" class="section level1">
<h1 class="hasAnchor">
<a href="#package-overview" class="anchor"></a>Package Overview</h1>
<p><code>RPadrino</code> provides an interface to the PADRINO database. PADRINO houses metadata on published Integral Projection Models, and all the information needed to rebuild them. <code>RPadrino</code> provides a set of functions that wrap around <a href="https://levisc8.github.io/ipmr/"><code>ipmr</code></a> so that you can rebuild these models using <em>R</em>. Additionally, there’s some data downloading and management functionality, as well as tools to help report and cite studies used in an analysis.</p>
</div>
<div id="usage" class="section level1">
<h1 class="hasAnchor">
<a href="#usage" class="anchor"></a>Usage</h1>
<p>Below are some very brief examples of how to select data based on the Metadata table, rebuild those models, and conduct an analysis. The first step for any of this is to access PADRINO. For first time users, this will always mean downloading it. For returning users, you may save and re-load PADRINO, but this example will not make use of the saving/loading functionality provided in <code><a href="../reference/pdb_download.html">pdb_load()</a></code> and <code><a href="../reference/pdb_download.html">pdb_save()</a></code>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">RPadrino</span><span class="op">)</span>

<span class="va">pdb</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pdb_download.html">pdb_download</a></span><span class="op">(</span>save <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<p>We’ve now downloaded the PADRINO database. It consists of 10 tables, all linked by <code>ipm_id</code>.</p>
<p>We can get a brief overview of the information using the <code>print</code> method:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">pdb</span></code></pre></div>
<pre><code>## A 'pdb' object with 56 unique species, 40 publications, and 280 models.
## Please cite all publications used in an analysis! These can be accessed with
## 'pdb_citations()'.
## 
## The following models have continuously varying environments: 
## aaaa15, aaaa16, aaaa21, aaaa54, aaaa59
## These can take longer to re-build - adjust your expectations accordingly!</code></pre>
<p>We see that some of the IPMs have continuously varying environments - we don’t want to use those for now because they take a while to run. We can use the <code><a href="../reference/pdb_subset.html">pdb_subset()</a></code> function to get only deterministic models. Because of the way PADRINO is structured, <code><a href="../reference/pdb_subset.html">pdb_subset()</a></code> only accepts a set of <code>ipm_id</code>’s that we want to <strong>keep</strong> (as opposed to other subset functions, which may accept some arbitrary logic). Thus, we need to create an index of those, which we can pass to <code><a href="../reference/pdb_subset.html">pdb_subset()</a></code> like so:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sub_ind</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sets.html">setdiff</a></span><span class="op">(</span><span class="va">pdb</span><span class="op">$</span><span class="va">Metadata</span><span class="op">$</span><span class="va">ipm_id</span>, 
                   <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"aaaa15"</span>, <span class="st">"aaaa16"</span>, <span class="st">"aaaa21"</span>, <span class="st">"aaaa54"</span>, <span class="st">"aaaa59"</span><span class="op">)</span><span class="op">)</span>

<span class="va">det_pdb</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pdb_subset.html">pdb_subset</a></span><span class="op">(</span><span class="va">pdb</span>, ipm_ids <span class="op">=</span> <span class="va">sub_ind</span><span class="op">)</span></code></pre></div>
<p>Great! Say we want to find all the <em>Asteraceae</em> in PADRINO. We can first check and see which <code>ipm_id</code>s correspond to those by querying the <code>tax_family</code> column of <code>pdb$Metadata</code>.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">aster_ind</span> <span class="op">&lt;-</span> <span class="va">det_pdb</span><span class="op">$</span><span class="va">Metadata</span><span class="op">$</span><span class="va">ipm_id</span><span class="op">[</span><span class="va">det_pdb</span><span class="op">$</span><span class="va">Metadata</span><span class="op">$</span><span class="va">tax_family</span> <span class="op">==</span> <span class="st">"Asteraceae"</span><span class="op">]</span>

<span class="va">aster_pdb</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pdb_subset.html">pdb_subset</a></span><span class="op">(</span><span class="va">pdb</span>, ipm_ids <span class="op">=</span> <span class="va">aster_ind</span><span class="op">)</span></code></pre></div>
<p>Next, we can rebuild their IPMs. This is a two step process in <code>RPadrino</code>. The first is to create <code>proto_ipm</code>s with <code><a href="../reference/pdb_make_proto_ipm.html">pdb_make_proto_ipm()</a></code>. This function takes a database object and, optionally, a subset of <code>ipm_id</code>s, and constructs a list of <code>proto_ipm</code>s. <code>proto_ipm</code>s are a common data structure used to represent IPM objects before they are actually constructed. One advantage of this extra step is that you can combine <code>proto_ipm</code>s generated from your own data with <code>ipmr</code> with <code>proto_ipm</code>s generated from PADRINO, so you can augment syntheses with your own data. An example of that is provided in the <em>Other Data Sources</em> vignette.</p>
<p>The simplest way to make <code>proto_ipm</code>s for a whole <code>pdb</code> object is:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">proto_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pdb_make_proto_ipm.html">pdb_make_proto_ipm</a></span><span class="op">(</span><span class="va">aster_pdb</span><span class="op">)</span></code></pre></div>
<pre><code>## 'ipm_id' aaa326 has the following notes that require your attention:
## aaa326: 'Demographic data from Metcalf Funct Ecol 2006'</code></pre>
<pre><code>## 'ipm_id' aaa329 has the following notes that require your attention:
## aaa329: 'Based on IPM from Rose Ecology 2005; The GPS coordinates were approximated
## to the closest geographic location described in the reference'</code></pre>
<p>We see that there are some notes that require our attention. The first tells us that this IPM is using data from another publication. The second warns us that GPS coordinates aren’t exact, so we should be cautious if we wanted to merge the outputs from this analysis with other spatially referenced datasets (e.g. gridded climate data). We can inspect the IPM structure by printing each <code>proto_ipm</code> object:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">proto_list</span> </code></pre></div>
<pre><code>## This list of 'proto_ipm's contains the following species: 
## Cirsium arvense
## Cirsium canescens
## 
## You can inspect each model by printing it individually.</code></pre>
<p>Next, we can reconstruct the IPMs using <code><a href="../reference/pdb_make_ipm.html">pdb_make_ipm()</a></code>. There are a variety of different options we can specify here, and we’ll get into how that works in the next example.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cirsiums</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pdb_make_ipm.html">pdb_make_ipm</a></span><span class="op">(</span><span class="va">proto_list</span><span class="op">)</span>

<span class="va">lambdas</span>  <span class="op">&lt;-</span> <span class="fu">lambda</span><span class="op">(</span><span class="va">cirsiums</span><span class="op">)</span>

<span class="va">cirsiums</span></code></pre></div>
<pre><code>## $aaa326
## A simple, density independent, deterministic IPM with 2 sub-kernel(s) defined. 
## Deterministic lambda = 1
## $aaa329
## A simple, density dependent, deterministic IPM with 1 sub-kernel(s) defined. 
## Lambda for the final time step of the model is: 1.146 
## Call lambda(x, type_lambda = "all") for deterministic lambdas
## from each iteration.
## attr(,"class")
## [1] "pdb_ipm" "list"</code></pre>
<p>We’ve rebuilt our first set of IPMs! Next, we’ll explore how to extract a bit more information from these.</p>
</div>
<div id="more-complicated-analyses" class="section level1">
<h1 class="hasAnchor">
<a href="#more-complicated-analyses" class="anchor"></a>More complicated analyses</h1>
<p>Often times, we’ll want more than just the deterministic population growth rates. We’ll explore how to run some more complicated analyses here. Specifically, we’ll compute the probability of surviving to age <span class="math inline">\(a\)</span>, <span class="math inline">\(l_a(z_0)\)</span> and the average per-capita fecundity at age <span class="math inline">\(a\)</span>, <span class="math inline">\(f_a(z_0)\)</span>. After that, we’ll compute mean and variance in lifespan (<span class="math inline">\(\bar\eta(z_0)\)</span> and <span class="math inline">\(\sigma_\eta^2 (z_0)\)</span>, respectively). Along the way, we’ll learn more about the structure of IPM objects in <code>RPadrino</code> and <code>ipmr</code>.</p>
<div id="the-dataset" class="section level2">
<h2 class="hasAnchor">
<a href="#the-dataset" class="anchor"></a>The dataset</h2>
<p>We’re going to use a subset of PADRINO IPMs to illustrate how to implement these calculations. We’ll select simple IPMs that are density-independent, deterministic, and from North America, so that things run a bit faster.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># This creates a table of the number of state variables per ipm_id. Since</span>
<span class="co"># simple IPMs, by defintion, have only 1 state variable, we can use the names</span>
<span class="co"># of the vector that it returns to choose only those. </span>

<span class="va">n_state_vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">pdb</span><span class="op">$</span><span class="va">StateVariables</span><span class="op">$</span><span class="va">ipm_id</span><span class="op">)</span> 
<span class="va">simple_mod_ind</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">n_state_vars</span><span class="op">)</span><span class="op">[</span><span class="va">n_state_vars</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span>


<span class="co"># Next, we want to capture any models that have stochastic dynamics, multiple</span>
<span class="co"># values per parameter, or density dependence. </span>

<span class="va">rm_mod_ind</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">pdb</span><span class="op">$</span><span class="va">EnvironmentalVariables</span><span class="op">$</span><span class="va">ipm_id</span>, <span class="co"># Stochastic models</span>
                       <span class="va">pdb</span><span class="op">$</span><span class="va">ParSetIndices</span><span class="op">$</span><span class="va">ipm_id</span>,          <span class="co"># Multiple parameter values</span>
                       <span class="va">pdb</span><span class="op">$</span><span class="va">Metadata</span><span class="op">$</span><span class="va">ipm_id</span><span class="op">[</span><span class="va">pdb</span><span class="op">$</span><span class="va">Metadata</span><span class="op">$</span><span class="va">has_dd</span><span class="op">]</span>, <span class="co"># Density dependent</span>
                       <span class="va">pdb</span><span class="op">$</span><span class="va">Metadata</span><span class="op">$</span><span class="va">ipm_id</span><span class="op">[</span><span class="va">pdb</span><span class="op">$</span><span class="va">Metadata</span><span class="op">$</span><span class="va">continent</span> <span class="op">!=</span> <span class="st">"n_america"</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>

<span class="co"># Remove these IDs from our simple_mod_ind vector</span>

<span class="va">simple_mod_ind</span> <span class="op">&lt;-</span> <span class="va">simple_mod_ind</span><span class="op">[</span><span class="op">!</span><span class="va">simple_mod_ind</span> <span class="op">%in%</span> <span class="va">rm_mod_ind</span><span class="op">]</span>

<span class="co"># We're also going to remove monocarpic perennials, as their survival/growth</span>
<span class="co"># kernels are slightly trickier to work with (note that there is an example</span>
<span class="co"># of working with these in the manuscript/si/case_study_1.pdf file in PADRINO</span>
<span class="co"># GitHub repository).</span>

<span class="va">monocarps</span> <span class="op">&lt;-</span> <span class="va">pdb</span><span class="op">$</span><span class="va">Metadata</span><span class="op">$</span><span class="va">ipm_id</span><span class="op">[</span><span class="va">pdb</span><span class="op">$</span><span class="va">Metadata</span><span class="op">$</span><span class="va">organism_type</span> <span class="op">==</span> <span class="st">"biennial"</span><span class="op">]</span>

<span class="va">simple_mod_ind</span> <span class="op">&lt;-</span> <span class="va">simple_mod_ind</span><span class="op">[</span><span class="op">!</span><span class="va">simple_mod_ind</span> <span class="op">%in%</span> <span class="va">monocarps</span><span class="op">]</span>

<span class="co"># Finally, we'll subset the database and build the IPM objects!</span>

<span class="va">simple_pdb</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pdb_subset.html">pdb_subset</a></span><span class="op">(</span><span class="va">pdb</span>, <span class="va">simple_mod_ind</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/pdb_make_proto_ipm.html">pdb_make_proto_ipm</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/pdb_make_ipm.html">pdb_make_ipm</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code>## 'ipm_id' aaa310 has the following notes that require your attention:
## aaa310: 'Geo and time info retrieved from COMPADRE (v.X.X.X.4)'</code></pre>
<pre><code>## 'ipm_id' aaa385 has the following notes that require your attention:
## aaa385: 'Same data as AAA385. State variable Height (Cm)'</code></pre>
<pre><code>## 'ipm_id' aaa388 has the following notes that require your attention:
## aaa388: 'Same data as AAA388. State variable Height (Cm)'</code></pre>
<pre><code>## 'ipm_id' dddd30 has the following notes that require your attention:
## dddd30: 'Frankenstein IPM'</code></pre>
<pre><code>## 'ipm_id' dddd31 has the following notes that require your attention:
## dddd31: 'Frankenstein IPM'</code></pre>
<pre><code>## 'ipm_id' dddd32 has the following notes that require your attention:
## dddd32: 'Frankenstein IPM'</code></pre>
<p>We now have 28 distinct <code>ipm_id</code>s to work with!</p>
</div>
<div id="age-specific-survival-and-fecundity" class="section level2">
<h2 class="hasAnchor">
<a href="#age-specific-survival-and-fecundity" class="anchor"></a>Age-specific survival and fecundity</h2>
<p>Age-specific calculations are straightforward once we’ve extracted sub-kernels. We can define functions that accept a single IPM object and then <code><a href="https://rdrr.io/r/base/lapply.html">lapply()</a></code> them to do our computations. We’ll start with <span class="math inline">\(l_a(z_0)\)</span> and <span class="math inline">\(f_a(z_0)\)</span>. These are defined by the following equations:</p>
<ol style="list-style-type: decimal">
<li><p><span class="math inline">\(l_a(z_0) = eP^a\)</span>, and</p></li>
<li><p><span class="math inline">\(f_a(z_0) = (eFP^a)/l_a\)</span>.</p></li>
</ol>
<p><span class="math inline">\(P\)</span> and <span class="math inline">\(F\)</span> are survival/growth and fecundity kernels, respectively. <span class="math inline">\(e\)</span> is a constant function <span class="math inline">\(e(z) \equiv 1\)</span>. Left multiplication with this function has the effect of summing columns. <span class="math inline">\(a\)</span> is the age we wish to do the calculations for.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">l_a</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">ipm</span>, <span class="va">a</span><span class="op">)</span> <span class="op">{</span>
    
  <span class="va">P</span> <span class="op">&lt;-</span> <span class="va">ipm</span><span class="op">$</span><span class="va">sub_kernels</span><span class="op">$</span><span class="va">P</span>
  
  <span class="co"># %^% is a function from ipmr that raises matrices to a power, rather than</span>
  <span class="co"># a pointwise power that ^ does.</span>
  
  <span class="va">P_a</span> <span class="op">&lt;-</span> <span class="va">P</span> <span class="op">%^%</span> <span class="va">a</span>
  
  <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">colSums</a></span><span class="op">(</span><span class="va">P_a</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">f_a</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">ipm</span>, <span class="va">a</span><span class="op">)</span> <span class="op">{</span>
    
  <span class="va">P</span> <span class="op">&lt;-</span> <span class="va">ipm</span><span class="op">$</span><span class="va">sub_kernels</span><span class="op">$</span><span class="va">P</span>
  <span class="cn">F</span> <span class="op">&lt;-</span> <span class="va">ipm</span><span class="op">$</span><span class="va">sub_kernels</span><span class="op">$</span><span class="cn">F</span>
  
  <span class="va">l_age</span> <span class="op">&lt;-</span> <span class="fu">l_a</span><span class="op">(</span><span class="va">ipm</span>, <span class="va">a</span><span class="op">)</span>
  
  <span class="va">P_a</span> <span class="op">&lt;-</span> <span class="va">P</span> <span class="op">%^%</span> <span class="va">a</span>
  
  <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">colSums</a></span><span class="op">(</span><span class="cn">F</span> <span class="op">%*%</span> <span class="va">P_a</span><span class="op">)</span> <span class="op">/</span> <span class="va">l_age</span>

<span class="op">}</span></code></pre></div>
<p>Now, we just need to apply our functions to the IPMs. We’ll compute survival and fecundities for 5 year olds, and then plot the results:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">l_as</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">simple_pdb</span>,
               <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">a</span><span class="op">)</span> <span class="fu">l_a</span><span class="op">(</span><span class="va">x</span>, <span class="va">a</span><span class="op">)</span>, 
               a <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>

<span class="va">f_as</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">simple_pdb</span>,
               <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">a</span><span class="op">)</span> <span class="fu">f_a</span><span class="op">(</span><span class="va">x</span>, <span class="va">a</span><span class="op">)</span>, 
               a <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>

<span class="co"># This only plots the figures for the first two species.</span>
<span class="co"># Remove the [1:2] to see all of them.</span>
<span class="co"># Uncomment the par(mfrow = c(...)) line to get an arrangement you like</span>

<span class="co"># par(mfrow = c(2, 2))</span>
<span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">l_as</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span> <span class="op">{</span>
  
  <span class="va">nm</span> <span class="op">&lt;-</span> <span class="va">pdb</span><span class="op">$</span><span class="va">Metadata</span><span class="op">$</span><span class="va">species_accepted</span><span class="op">[</span><span class="va">pdb</span><span class="op">$</span><span class="va">Metadata</span><span class="op">$</span><span class="va">ipm_id</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">l_as</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>
  
  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">l_as</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, type <span class="op">=</span> <span class="st">"l"</span>,
       <span class="co"># ylim = c(0, 1),</span>
       main <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">nm</span>,<span class="st">": Probability of survival to age 5"</span><span class="op">)</span>,
       xlab <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Initial size z"</span><span class="op">[</span><span class="fl">0</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>,
       ylab <span class="op">=</span> <span class="st">"Pr(s)"</span><span class="op">)</span>
  
  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">f_as</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, type <span class="op">=</span> <span class="st">"l"</span>,
       <span class="co"># ylim = c(0, 1),</span>
       main <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">nm</span>,<span class="st">": Expected Fecundity at age 5 (given survival)"</span><span class="op">)</span>,
       xlab <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Initial size z"</span><span class="op">[</span><span class="fl">0</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>,
       ylab <span class="op">=</span> <span class="st">"E[f]"</span><span class="op">)</span>
  
<span class="op">}</span></code></pre></div>
<p><img src="padrino-intro_files/figure-html/unnamed-chunk-10-1.png" width="768"><img src="padrino-intro_files/figure-html/unnamed-chunk-10-2.png" width="768"><img src="padrino-intro_files/figure-html/unnamed-chunk-10-3.png" width="768"><img src="padrino-intro_files/figure-html/unnamed-chunk-10-4.png" width="768"></p>
<p>We can also generate survivorship curves for each one to investigate type I/II/III species. These require simulating cohorts for a number of years using the <span class="math inline">\(P\)</span> and <span class="math inline">\(F\)</span> kernels. Because this can take some time to run, we’ll only do it for a single model for each species in our data set.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">keep_ind</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pdb_subset.html">pdb_subset</a></span><span class="op">(</span><span class="va">pdb</span>, <span class="va">simple_mod_ind</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="va">.</span><span class="op">$</span><span class="va">Metadata</span> <span class="op">%&gt;%</span>
  <span class="va">.</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/duplicated.html">duplicated</a></span><span class="op">(</span><span class="va">.</span><span class="op">$</span><span class="va">species_accepted</span><span class="op">)</span>, <span class="st">"ipm_id"</span><span class="op">]</span>

<span class="va">use_ipms</span> <span class="op">&lt;-</span> <span class="va">simple_pdb</span><span class="op">[</span><span class="va">keep_ind</span><span class="op">]</span>


<span class="va">n_yrs</span> <span class="op">&lt;-</span> <span class="fl">10</span>

<span class="va">init_pops</span> <span class="op">&lt;-</span> <span class="fu">right_ev</span><span class="op">(</span><span class="va">use_ipms</span><span class="op">)</span></code></pre></div>
<pre><code>## 'x' did not converge to asymptotic dynamics after 51 iterations.
## Will re-iterate the model 100 times and check for convergence.</code></pre>
<pre><code>## model is now converged :)</code></pre>
<pre><code>## 'x' did not converge to asymptotic dynamics after 51 iterations.
## Will re-iterate the model 100 times and check for convergence.</code></pre>
<pre><code>## model is now converged :)</code></pre>
<pre><code>## 'x' did not converge to asymptotic dynamics after 51 iterations.
## Will re-iterate the model 100 times and check for convergence.</code></pre>
<pre><code>## model is now converged :)</code></pre>
<pre><code>## 'x' did not converge to asymptotic dynamics after 51 iterations.
## Will re-iterate the model 100 times and check for convergence.</code></pre>
<pre><code>## model is now converged :)</code></pre>
<pre><code>## 'x' did not converge to asymptotic dynamics after 51 iterations.
## Will re-iterate the model 100 times and check for convergence.</code></pre>
<pre><code>## model is now converged :)</code></pre>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># As above, remove the [1:2] to see all plots and use par() to control their</span>
<span class="co"># arrangement</span>
<span class="co"># par(mfrow = c(3, 2))</span>

<span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">init_pops</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span> <span class="op">{</span>
  
  <span class="va">f_age</span> <span class="op">&lt;-</span> <span class="va">l_age</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="va">n_yrs</span><span class="op">)</span> 
  
  <span class="va">P_a</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">use_ipms</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">sub_kernels</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>
  
  
  <span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="va">n_yrs</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    
    <span class="va">P_now</span> <span class="op">&lt;-</span> <span class="va">use_ipms</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">sub_kernels</span><span class="op">$</span><span class="va">P</span>
    <span class="va">F_now</span> <span class="op">&lt;-</span> <span class="va">use_ipms</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">sub_kernels</span><span class="op">$</span><span class="cn">F</span>

    <span class="va">l_age</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html">colSums</a></span><span class="op">(</span><span class="va">P_a</span><span class="op">)</span> <span class="op">*</span> <span class="va">init_pops</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> 
    <span class="va">f_age</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html">colSums</a></span><span class="op">(</span><span class="va">F_now</span> <span class="op">%*%</span> <span class="va">P_a</span><span class="op">)</span> <span class="op">*</span> <span class="va">init_pops</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>
    
    <span class="va">P_a</span> <span class="op">&lt;-</span> <span class="va">P_now</span> <span class="op">%*%</span> <span class="va">P_a</span>
  <span class="op">}</span>
  
  <span class="va">f_age</span> <span class="op">&lt;-</span> <span class="va">f_age</span> <span class="op">/</span> <span class="va">l_age</span>
  
  <span class="va">nm</span> <span class="op">&lt;-</span> <span class="va">pdb</span><span class="op">$</span><span class="va">Metadata</span><span class="op">$</span><span class="va">species_accepted</span><span class="op">[</span><span class="va">pdb</span><span class="op">$</span><span class="va">Metadata</span><span class="op">$</span><span class="va">ipm_id</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">init_pops</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>
  
  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">l_age</span>, type <span class="op">=</span> <span class="st">"l"</span>,
       ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>,
       main <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">nm</span>, <span class="st">": Probability of survival"</span><span class="op">)</span>,
       xlab <span class="op">=</span> <span class="st">"Age"</span>,
       ylab <span class="op">=</span> <span class="st">"Pr(s)"</span><span class="op">)</span>
  
  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">f_age</span>, type <span class="op">=</span> <span class="st">"l"</span>,
       <span class="co"># ylim = c(0, 1),</span>
       main <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">nm</span>, <span class="st">": Average Fecundity"</span><span class="op">)</span>,
       xlab <span class="op">=</span> <span class="st">"Age"</span>,
       ylab <span class="op">=</span> <span class="st">"E[f]"</span><span class="op">)</span>
  
<span class="op">}</span></code></pre></div>
<p><img src="padrino-intro_files/figure-html/unnamed-chunk-11-1.png" width="768"><img src="padrino-intro_files/figure-html/unnamed-chunk-11-2.png" width="768"><img src="padrino-intro_files/figure-html/unnamed-chunk-11-3.png" width="768"><img src="padrino-intro_files/figure-html/unnamed-chunk-11-4.png" width="768"></p>
</div>
<div id="mean-and-variance-in-lifespan" class="section level2">
<h2 class="hasAnchor">
<a href="#mean-and-variance-in-lifespan" class="anchor"></a>Mean and variance in lifespan</h2>
<p><span class="math inline">\(\bar\eta(z_0)\)</span> is given by the following equation: <span class="math inline">\(\bar\eta(z_0) = eN\)</span>, where <span class="math inline">\(N\)</span> is the fundamental operator. This can be thought of as the expected amount of time an individual with initial state <span class="math inline">\(z_0\)</span> spends in state <span class="math inline">\(z'\)</span> before death. It is computed as <span class="math inline">\((I - P)^{-1}\)</span>, where <span class="math inline">\(I\)</span> is an identity operator (in practice, it is an identity matrix with dimension equal to <span class="math inline">\(P\)</span>), and <span class="math inline">\(P\)</span> is the survival/growth kernel of the IPM. Thus, all we need are the <span class="math inline">\(P\)</span> kernels from each model.</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">make_N</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">ipm</span><span class="op">)</span> <span class="op">{</span>
  
  <span class="va">P</span> <span class="op">&lt;-</span> <span class="va">ipm</span><span class="op">$</span><span class="va">sub_kernel</span><span class="op">$</span><span class="va">P</span>
  <span class="va">I</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">P</span><span class="op">)</span><span class="op">)</span>
  <span class="va">N</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/solve.html">solve</a></span><span class="op">(</span><span class="va">I</span> <span class="op">-</span> <span class="va">P</span><span class="op">)</span>
  
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span>
<span class="op">}</span>
<span class="va">eta_bar_z0</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">ipm</span><span class="op">)</span> <span class="op">{</span>
  
  <span class="va">N</span> <span class="op">&lt;-</span> <span class="fu">make_N</span><span class="op">(</span><span class="va">ipm</span><span class="op">)</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html">colSums</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span><span class="op">)</span>
  
<span class="op">}</span>

<span class="va">mean_lifespan</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">use_ipms</span>, <span class="va">eta_bar_z0</span><span class="op">)</span> </code></pre></div>
<p>The formula for the variance in lifespan is only a bit more complicated. It is given by <span class="math inline">\(\sigma_\eta^2(z_0) = e(2N^2 - N) - (eN)^2\)</span>. For this, we also need to use <code>ipmr</code>’s <code>%^%</code> operator to ensure we correctly exponentiate the first term, and use the regular <code><a href="https://rdrr.io/r/base/Arithmetic.html">^</a></code> to exponentiate the second term. Calculating <span class="math inline">\(N\)</span> is the same as before, we’ll compute the variance and standard deviation of lifespan (for plotting).</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sigma_eta_z0</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">ipm</span><span class="op">)</span> <span class="op">{</span>
  
  <span class="va">N</span> <span class="op">&lt;-</span> <span class="fu">make_N</span><span class="op">(</span><span class="va">ipm</span><span class="op">)</span>
  
  <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">colSums</a></span><span class="op">(</span><span class="fl">2</span> <span class="op">*</span> <span class="va">N</span> <span class="op">%^%</span> <span class="fl">2</span> <span class="op">-</span> <span class="va">N</span><span class="op">)</span> <span class="op">-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html">colSums</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span><span class="op">)</span> <span class="op">^</span> <span class="fl">2</span>
  
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span>
  
<span class="op">}</span>

<span class="va">var_lifespan</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">use_ipms</span>, <span class="va">sigma_eta_z0</span><span class="op">)</span>

<span class="va">sd_lifespan</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">var_lifespan</span>, <span class="va">sqrt</span><span class="op">)</span></code></pre></div>
<p>Warning? Huh? Let’s see what’s going on.</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">vapply</a></span><span class="op">(</span><span class="va">mean_lifespan</span>, <span class="va">range</span>, <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="fl">2L</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>##        aaaa34   aaaa36   aaa310     aaa341   aaa351   aaa385   ddddd5   dddd10
## [1,] 1.810595 1.590430  6.36749 -348825.70 1.045242 1.005169 2.106308 1.000000
## [2,] 3.739900 5.874642 13.68391  -30555.21 2.023906 3.631503 4.638129 1.626605
##        dddd30
## [1,] 1.299821
## [2,] 1.537262</code></pre>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">vapply</a></span><span class="op">(</span><span class="va">var_lifespan</span>, <span class="va">range</span>, <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="fl">2L</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>##        aaaa34    aaaa36    aaa310       aaa341     aaa351     aaa385   ddddd5
## [1,] 2.475952  2.774118  71.19712  20383705217 0.05439601 0.02589388  3.35095
## [2,] 6.023528 13.706128 115.84883 121676736576 0.99166204 9.44496008 13.28191
##         dddd10    dddd30
## [1,] 0.0000000 0.3902612
## [2,] 0.9258931 0.7019200</code></pre>
<p>The fundamental operator should not have any negative numbers, and yet <code>aaa341</code> contains them. This is because of the survival function used in the model. We’ll show how to remedy this in the next section, but for now, we’ll just remove it from our analysis. Next, we’ll learn how to visualize our results quickly with <code>ggplot2</code>:</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mean_lifespan</span> <span class="op">&lt;-</span> <span class="va">mean_lifespan</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">mean_lifespan</span><span class="op">)</span> <span class="op">%in%</span> <span class="st">"aaa341"</span><span class="op">]</span>
<span class="va">sd_lifespan</span>  <span class="op">&lt;-</span> <span class="va">sd_lifespan</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">sd_lifespan</span><span class="op">)</span> <span class="op">%in%</span> <span class="st">"aaa341"</span><span class="op">]</span>

<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span></code></pre></div>
<pre><code>## Warning: package 'ggplot2' was built under R version 4.1.1</code></pre>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">all_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>
  id      <span class="op">=</span> <span class="cn">NA</span>,
  species <span class="op">=</span> <span class="cn">NA</span>,
  mean_ls <span class="op">=</span> <span class="cn">NA</span>,
  upper   <span class="op">=</span> <span class="cn">NA</span>,
  lower   <span class="op">=</span> <span class="cn">NA</span>,
  z_0     <span class="op">=</span> <span class="cn">NA</span>
<span class="op">)</span>

<span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">mean_lifespan</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  
  <span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>
    id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">mean_lifespan</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,
    species <span class="op">=</span> <span class="va">pdb</span><span class="op">$</span><span class="va">Metadata</span><span class="op">$</span><span class="va">species_accepted</span><span class="op">[</span><span class="va">pdb</span><span class="op">$</span><span class="va">Metadata</span><span class="op">$</span><span class="va">ipm_id</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">mean_lifespan</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>,
    mean_ls <span class="op">=</span> <span class="va">mean_lifespan</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>,
    upper   <span class="op">=</span> <span class="va">mean_lifespan</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1.96</span> <span class="op">*</span> <span class="va">sd_lifespan</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>,
    lower   <span class="op">=</span> <span class="va">mean_lifespan</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">-</span> <span class="fl">1.96</span> <span class="op">*</span> <span class="va">sd_lifespan</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>,
    z_0     <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">mean_lifespan</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span>
  <span class="op">)</span>
  
  <span class="va">all_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">all_data</span>, <span class="va">temp</span><span class="op">)</span>
  
<span class="op">}</span>

<span class="co"># Remove the NA dummy row, and restrict the lower CI to &gt;= 0 (can't have negative</span>
<span class="co"># lifespan)</span>

<span class="va">all_data</span> <span class="op">&lt;-</span> <span class="va">all_data</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span>, <span class="op">]</span>
<span class="va">all_data</span><span class="op">$</span><span class="va">lower</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">all_data</span><span class="op">$</span><span class="va">lower</span> <span class="op">&lt;</span> <span class="fl">0</span>, <span class="fl">0</span>, <span class="va">all_data</span><span class="op">$</span><span class="va">lower</span><span class="op">)</span>


<span class="co"># Now, ggplot using facet wrap and geom_ribbon to get the confidence interval</span>

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">all_data</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">z_0</span>, y <span class="op">=</span> <span class="va">mean_ls</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">lower</span>,
                  ymax <span class="op">=</span> <span class="va">upper</span><span class="op">)</span>,
              fill <span class="op">=</span> <span class="st">"grey50"</span>,
              alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span> <span class="op">~</span> <span class="va">species</span>,
              scales <span class="op">=</span> <span class="st">"free"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p><img src="padrino-intro_files/figure-html/unnamed-chunk-15-1.png" width="960"></p>
</div>
</div>
<div id="correcting-issues-with-data" class="section level1">
<h1 class="hasAnchor">
<a href="#correcting-issues-with-data" class="anchor"></a>Correcting issues with data</h1>
<p>We saw above that sometimes data in PADRINO can give values that make no sense. PADRINO is committed to providing IPMs <em>as they are published</em>, and does not take a stance on the technical correctness of these models. The analysis above provides an opportunity to quickly illustrate how to address some of these issues. There is a separate vignette with a more complete overview of known issues in PADRINO.</p>
<div id="quick-solution" class="section level2">
<h2 class="hasAnchor">
<a href="#quick-solution" class="anchor"></a>Quick solution</h2>
<p>We’ll introduce two new functions - <code>vital_rate_exprs&lt;-</code> and <code><a href="../reference/vital_rate_exprs.pdb_proto_ipm_list.html">pdb_new_fun_form()</a></code>. Since we’re computing all new survival values, we’ll have to modify the <code>proto_ipm</code> first, then re-build the IPM object (the species in question is <em>Lonicera maackii</em>).</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">lonicera_proto</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pdb_make_proto_ipm.html">pdb_make_proto_ipm</a></span><span class="op">(</span><span class="va">pdb</span>, <span class="st">"aaa341"</span><span class="op">)</span>

<span class="co"># Inspect the vital rate expressions</span>
<span class="fu">vital_rate_exprs</span><span class="op">(</span><span class="va">lonicera_proto</span><span class="op">)</span></code></pre></div>
<pre><code>## $aaa341
## s: 1/(1 + exp(-(si + ss1 * size_1 + ss2 * size_1^2)))
## g_mean: gi + gs * size_1
## g: stats::dnorm(size_2, g_mean, g_sd)
## Fp: 1/(1 + exp(-(fpi + fps * size_1)))
## Fs: exp(fi + fs * size_1)
## Fd: stats::dnorm(size_2, fd_mean, fd_sd)</code></pre>
<p>We can see that the function <code>s</code> is the one we want to update. We’ll use the setter <code>vital_rate_exprs&lt;-</code> and <code><a href="../reference/vital_rate_exprs.pdb_proto_ipm_list.html">pdb_new_fun_form()</a></code> to do this. These two functions combine with the following syntax:</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">vital_rate_exprs</span>(proto_ipms) <span class="ot">&lt;-</span> <span class="fu">pdb_new_fun_form</span>(</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>    <span class="sc">&lt;</span>ipm_id_1<span class="sc">&gt;</span> <span class="er">=</span> <span class="fu">list</span>(</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>      <span class="sc">&lt;</span>vital_rate_name_1<span class="sc">&gt;</span> <span class="er">=</span> <span class="er">&lt;</span>expression_1<span class="sc">&gt;</span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>      <span class="er">&lt;</span>vital_rate_name_2<span class="sc">&gt;</span> <span class="er">=</span> <span class="er">&lt;</span>expression_2<span class="sc">&gt;</span></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>    <span class="sc">&lt;</span>ipm_id_2<span class="sc">&gt;</span> <span class="er">=</span> <span class="fu">list</span>(</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>      <span class="sc">&lt;</span>vital_rate_name_3<span class="sc">&gt;</span> <span class="er">=</span> <span class="er">&lt;</span>expression_3<span class="sc">&gt;</span></span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>With a maximum survival probability of 0.98, our example of <code>aaa341</code> looks like this:</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">vital_rate_exprs</span><span class="op">(</span><span class="va">lonicera_proto</span><span class="op">)</span> <span class="op">&lt;-</span><span class="fu"><a href="../reference/vital_rate_exprs.pdb_proto_ipm_list.html">pdb_new_fun_form</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    aaa341 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
      s <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmin</a></span><span class="op">(</span><span class="fl">0.98</span>, <span class="fl">1</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="op">-</span><span class="op">(</span><span class="va">si</span> <span class="op">+</span> <span class="va">ss1</span> <span class="op">*</span> <span class="va">size_1</span> <span class="op">+</span> <span class="va">ss2</span> <span class="op">*</span> <span class="va">size_1</span> <span class="op">^</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
    <span class="op">)</span>
  <span class="op">)</span>
<span class="op">)</span>

<span class="fu">vital_rate_exprs</span><span class="op">(</span><span class="va">lonicera_proto</span><span class="op">)</span></code></pre></div>
<pre><code>## $aaa341
## s: pmin(0.98, 1/(1 + exp(-(si + ss1 * size_1 + ss2 * size_1^2))))
## g_mean: gi + gs * size_1
## g: stats::dnorm(size_2, g_mean, g_sd)
## Fp: 1/(1 + exp(-(fpi + fps * size_1)))
## Fs: exp(fi + fs * size_1)
## Fd: stats::dnorm(size_2, fd_mean, fd_sd)</code></pre>
<p>Great! Let’s re-run the analysis above with our corrected model!</p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Rebuild the IPM, then use our functions for mean, variance, and SD on it.</span>
<span class="va">lonicera_ipm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pdb_make_ipm.html">pdb_make_ipm</a></span><span class="op">(</span><span class="va">lonicera_proto</span><span class="op">)</span>

<span class="va">lonicera_mu_ls</span>  <span class="op">&lt;-</span> <span class="fu">eta_bar_z0</span><span class="op">(</span><span class="va">lonicera_ipm</span><span class="op">$</span><span class="va">aaa341</span><span class="op">)</span>
<span class="va">lonicera_var_ls</span> <span class="op">&lt;-</span> <span class="fu">sigma_eta_z0</span><span class="op">(</span><span class="va">lonicera_ipm</span><span class="op">$</span><span class="va">aaa341</span><span class="op">)</span>
<span class="va">lonicera_sd_ls</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">lonicera_var_ls</span><span class="op">)</span>

<span class="va">temp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>
    id <span class="op">=</span> <span class="st">"aaa341"</span>,
    species <span class="op">=</span> <span class="st">"Lonicera_maackii"</span>,
    mean_ls <span class="op">=</span> <span class="va">lonicera_mu_ls</span>,
    upper   <span class="op">=</span> <span class="va">lonicera_mu_ls</span> <span class="op">+</span> <span class="fl">1.96</span> <span class="op">*</span> <span class="va">lonicera_sd_ls</span>,
    lower   <span class="op">=</span> <span class="va">lonicera_mu_ls</span> <span class="op">-</span> <span class="fl">1.96</span> <span class="op">*</span> <span class="va">lonicera_sd_ls</span>,
    z_0     <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">lonicera_mu_ls</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span>
  <span class="op">)</span>


<span class="va">all_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">all_data</span>, <span class="va">temp</span><span class="op">)</span>

<span class="co"># Again, restrict the lower CI to have minimum of 0</span>
<span class="va">all_data</span><span class="op">$</span><span class="va">lower</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">all_data</span><span class="op">$</span><span class="va">lower</span> <span class="op">&lt;</span> <span class="fl">0</span>, <span class="fl">0</span>, <span class="va">all_data</span><span class="op">$</span><span class="va">lower</span><span class="op">)</span>


<span class="co"># Rebuild our plot!</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">all_data</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">z_0</span>, y <span class="op">=</span> <span class="va">mean_ls</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">lower</span>,
                  ymax <span class="op">=</span> <span class="va">upper</span><span class="op">)</span>,
              fill <span class="op">=</span> <span class="st">"grey50"</span>,
              alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span> <span class="op">~</span> <span class="va">species</span>,
              scales <span class="op">=</span> <span class="st">"free"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p><img src="padrino-intro_files/figure-html/unnamed-chunk-19-1.png" width="960"></p>
<p>The results look a bit better for <em>Lonicera</em>, and are at least now mathematically correct. When updating functional forms in PADRINO, it is important to explore how assumptions like the maximum survival probability in the modified form affect results. This is left as an exercise to you!</p>
</div>
</div>
<div id="further-reading" class="section level1">
<h1 class="hasAnchor">
<a href="#further-reading" class="anchor"></a>Further reading</h1>
<p>This is just a very brief overview of the analyses that are possible with <code>RPadrino</code>. <a href="https://link.springer.com/content/pdf/10.1007/978-3-319-28893-2.pdf">Ellner, Childs &amp; Rees 2016</a> give a comprehensive overview of IPM theory and analyses. There are further vignettes in this package that describe data cleaning and how to use PADRINO with other databases.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="https://github.com/levisc8">Sam Levin</a>, Sanne Evers, Tomos Potter, Dylan Childs, Aldo Compagnoni, Roberto Salguero-Gomez, Tiffany Knight.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
